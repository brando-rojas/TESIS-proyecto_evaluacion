{% extends "base.html" %}

{% block title %}Resultado de tu Entrega{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-check-circle"></i> Resultado de tu Entrega</h2>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">Evaluación: {{ evaluacion.entrega.pregunta.enunciado | striptags | truncate(40, True, '...') }}</h5>
        <div class="row">
            <div class="col-md-6">
                <p class="card-text"><strong>Fecha de Entrega:</strong> {{ evaluacion.entrega.fecha_entrega.strftime('%Y-%m-%d %H:%M') }}</p>
                <p class="card-text"><strong>Puntaje Obtenido:</strong>
                    <span class="badge {% if evaluacion.puntaje_obtenido == evaluacion.entrega.pregunta.puntaje_total %}bg-success{% elif evaluacion.puntaje_obtenido > 0 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                        {{ evaluacion.puntaje_obtenido }} / {{ evaluacion.entrega.pregunta.puntaje_total }}
                    </span>
                </p>
            </div>
            <div class="col-md-6">
                <p class="card-text"><strong>Fecha Evaluación:</strong> {{ evaluacion.fecha_evaluacion.strftime('%Y-%m-%d %H:%M') }}</p>
                <p class="card-text"><strong>Lenguaje:</strong> {{ evaluacion.entrega.pregunta.lenguaje_programacion }}</p>
            </div>
        </div>

        <!-- Resumen de Feedback -->
        <div class="mt-3">
            <div class="accordion" id="feedbackAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#feedbackBody" aria-expanded="true" aria-controls="feedbackBody">
                            <strong><i class="fas fa-comment"></i> Feedback General</strong>
                        </button>
                    </h2>
                    <div id="feedbackBody" class="accordion-collapse collapse show" data-bs-parent="#feedbackAccordion">
                        <div class="accordion-body">
                            <pre class="feedback-text">{{ evaluacion.feedback }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resultados Detallados de Casos de Prueba -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-tasks"></i> Resultados Detallados de Casos de Prueba</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Caso</th>
                        <th>Entrada</th>
                        <th>Salida Esperada</th>
                        <th>Salida Obtenida</th>
                        <th>Estado</th>
                        <th>Tiempo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resultado in evaluacion.resultados %}
                    <tr class="{% if resultado.paso %}table-success{% else %}table-danger{% endif %}">
                        <td>
                            <span class="fw-bold">{{ loop.index }}</span>
                            {% if resultado.caso_de_prueba.descripcion %}
                            <br><small>{{ resultado.caso_de_prueba.descripcion }}</small>
                            {% endif %}

                            {% if resultado.caso_de_prueba.es_oculto %}
                            <span class="badge bg-secondary ms-1" title="Caso de prueba oculto">
                                <i class="fas fa-eye-slash"></i> Oculto
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if resultado.caso_de_prueba.es_oculto %}
                                <div class="text-muted fst-italic">
                                    <i class="fas fa-eye-slash"></i> Caso de prueba oculto
                                </div>
                            {% else %}
                                <div class="code-display">
                                    {% if resultado.entrada_repr %}
                                        <code>{{ resultado.entrada_repr }}</code>
                                    {% else %}
                                        <code>{{ resultado.caso_de_prueba.entrada|default('-', true) }}</code>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if resultado.caso_de_prueba.es_oculto %}
                                <div class="text-muted fst-italic">
                                    <i class="fas fa-eye-slash"></i> Caso de prueba oculto
                                </div>
                            {% else %}
                                <div class="code-display">
                                    {% if resultado.salida_esperada_repr %}
                                        <code>{{ resultado.salida_esperada_repr }}</code>
                                    {% else %}
                                        <code>{{ resultado.caso_de_prueba.salida_esperada }}</code>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if resultado.caso_de_prueba.es_oculto %}
                                <div class="text-muted fst-italic">
                                    <i class="fas fa-eye-slash"></i> Caso de prueba oculto
                                </div>
                            {% else %}
                                <div class="code-display">
                                    {% if resultado.salida_obtenida_repr %}
                                        <code>{{ resultado.salida_obtenida_repr }}</code>
                                    {% else %}
                                        <code>{{ resultado.salida_obtenida }}</code>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if resultado.paso %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Correcto</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="fas fa-times"></i> Incorrecto</span>
                            {% endif %}
                            <div class="mt-2">
                                <span class="badge bg-secondary">{{ resultado.puntos_obtenidos }} pts</span>
                            </div>
                            {% if resultado.estado_ejecucion %}
                                <div class="mt-2">
                                    <small class="text-muted">{{ resultado.estado_ejecucion }}</small>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if resultado.tiempo_ejecucion_ms %}
                                {{ resultado.tiempo_ejecucion_ms }} ms
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>

                    {% if not resultado.paso and resultado.diferencias_resumen and not resultado.caso_de_prueba.es_oculto %}
                    <tr class="table-light">
                        <td colspan="6">
                            <div class="accordion" id="diferencias{{ loop.index }}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#diferenciasBody{{ loop.index }}" aria-expanded="false">
                                            <i class="fas fa-exchange-alt"></i> Ver diferencias
                                        </button>
                                    </h2>
                                    <div id="diferenciasBody{{ loop.index }}" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <pre class="diferencias-text">{{ resultado.diferencias_resumen }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Los casos de prueba marcados como <span class="badge bg-secondary"><i class="fas fa-eye-slash"></i> Oculto</span> tienen sus detalles protegidos para evaluar mejor tu solución.
            </div>
        </div>
    </div>
</div>

<!-- INICIO: Nueva sección para la tabla de Rúbrica LLM -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Evaluación Detallada por Rúbrica (LLM)</h5>
    </div>
    <div class="card-body">
        {% if evaluacion.feedback_llm_general %}
        <div class="alert alert-light border mb-4">
            <h6 class="alert-heading"><i class="fa-solid fa-brain me-2"></i></i><span>Feedback General de la IA</span></h6>
            <p class="mb-0">{{ evaluacion.feedback_llm_general }}</p>
        </div>
        {% endif %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tabla-rubrica-evaluacion-{{ evaluacion.id }}">
                <thead>
                    <!-- El JavaScript llenará esta cabecera -->
                </thead>
                <tbody>
                    <!-- El JavaScript llenará este cuerpo -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- FIN: Nueva sección para la tabla de Rúbrica LLM -->


<div class="mt-3 d-flex justify-content-between">
    <a href="{{ url_for('dashboard') }}" class="btn btn-primary"><i class="fas fa-home"></i> Volver al Dashboard</a>
</div>

{% endblock %}

{% block scripts %}
    {{ super() }}

    <!-- CARGA EXPLÍCITA DE JQUERY (para depuración o si base.html no lo hace) -->
    <!-- Asegúrate de que esta URL sea accesible o reemplázala con tu ruta local si es necesario -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- FIN DE CARGA EXPLÍCITA DE JQUERY -->

    <script>
        // Usar $(function() { ... }) es la forma idiomática de jQuery para $(document).ready(function() { ... })
        // Se ejecutará cuando el DOM esté listo Y jQuery esté disponible.
        $(function() {
            console.log("SCRIPT: DOM ready y script de ver_resultado.html ejecutándose.");

            // Verificar si jQuery está realmente cargado
            if (typeof jQuery == 'undefined') {
                console.error("SCRIPT: ¡jQuery no está cargado A PESAR DE LA CARGA EXPLÍCITA! Verifica la URL/ruta de jQuery y la consola de red.");
                // También verifica si hay algún error previo en la consola que pueda detener la ejecución de scripts.
                // Podrías intentar cargar jQuery de otra fuente o localmente si el CDN falla.
                // Ejemplo de carga local (asegúrate de que la ruta sea correcta):
                // var script = document.createElement('script');
                // script.src = "{{ url_for('static', filename='js/jquery.min.js') }}"; // Ajusta esta ruta
                // script.onload = function() {
                //     console.log("SCRIPT: jQuery cargado localmente como último recurso.");
                //     // Aquí podrías reintentar la inicialización si la carga asíncrona funcionó.
                //     // Pero es mejor arreglar la carga principal.
                // };
                // document.head.appendChild(script);
                return; // Detener si jQuery no está
            } else {
                console.log("SCRIPT: jQuery versión " + $.fn.jquery + " está cargado.");
            }

            // El resto de tu script (parseo de JSON, funciones, llamada a construirTablaRubricaVisualizacion)
            // permanece igual que en la respuesta anterior.
            // ... (copia el resto del script de la respuesta anterior aquí) ...

            const rawRubricaDataJson = {{ rubrica_data_json|tojson|safe }};
            const rawResultadosLlmJson = {{ resultados_llm_json|tojson|safe }};
            const evaluacionId = "{{ evaluacion.id }}";

            console.log("SCRIPT: Raw rubrica_data_json:", rawRubricaDataJson);
            console.log("SCRIPT: Raw resultados_llm_json:", rawResultadosLlmJson);
            console.log("SCRIPT: evaluacion.id:", evaluacionId);

            let rubricaEstructuraGlobal;
            let resultadosLLMGlobal;

            try {
                // Intenta parsear directamente, ya que Jinja lo convierte en un string literal de JS
                rubricaEstructuraGlobal = rawRubricaDataJson; // Asumiendo que tojson|safe lo hace un objeto JS válido
                if (typeof rubricaEstructuraGlobal === 'string') { // Si sigue siendo string, parsear
                    rubricaEstructuraGlobal = JSON.parse(rubricaEstructuraGlobal);
                }
                console.log("SCRIPT: Parsed rubricaEstructuraGlobal:", rubricaEstructuraGlobal);
            } catch (e) {
                console.error("SCRIPT: Error al parsear rubrica_data_json:", e, ". Raw data:", rawRubricaDataJson);
                rubricaEstructuraGlobal = { criterios: [] };
            }

            try {
                resultadosLLMGlobal = rawResultadosLlmJson; // Asumiendo que tojson|safe lo hace un objeto JS válido
                 if (typeof resultadosLLMGlobal === 'string') { // Si sigue siendo string, parsear
                    resultadosLLMGlobal = JSON.parse(resultadosLLMGlobal);
                }
                console.log("SCRIPT: Parsed resultadosLLMGlobal:", resultadosLLMGlobal);
            } catch (e) {
                console.error("SCRIPT: Error al parsear resultados_llm_json:", e, ". Raw data:", rawResultadosLlmJson);
                resultadosLLMGlobal = [];
            }


            function obtenerResultadoLLMParaCriterio(nombreCriterio, resultadosLLM) {
                if (!resultadosLLM || !Array.isArray(resultadosLLM)) {
                    return null;
                }
                return resultadosLLM.find(r => r.criterio_nombre === nombreCriterio);
            }

            function construirTablaRubricaVisualizacion(tablaId, rubricaData, resultadosLLM) {
                console.log("FUNC construirTablaRubricaVisualizacion: Iniciando para tablaId:", tablaId);
                // console.log("FUNC construirTablaRubricaVisualizacion: rubricaData:", JSON.stringify(rubricaData, null, 2));
                // console.log("FUNC construirTablaRubricaVisualizacion: resultadosLLM:", JSON.stringify(resultadosLLM, null, 2));


                const $tabla = $('#' + tablaId);
                if (!$tabla.length) {
                    console.error("FUNC construirTablaRubricaVisualizacion: ¡ERROR! No se encontró el elemento tabla con ID:", tablaId);
                    return;
                }
                console.log("FUNC construirTablaRubricaVisualizacion: Elemento tabla encontrado:", $tabla[0]); // $tabla[0] es el elemento DOM

                $tabla.find('thead').empty();
                $tabla.find('tbody').empty();
                console.log("FUNC construirTablaRubricaVisualizacion: thead y tbody vaciados.");

                if (!rubricaData || !rubricaData.criterios || !Array.isArray(rubricaData.criterios) || rubricaData.criterios.length === 0) {
                    console.warn("FUNC construirTablaRubricaVisualizacion: Datos de rúbrica vacíos o formato incorrecto.", "TablaId:", tablaId, "RubricaData:", rubricaData);
                    $tabla.find('tbody').append('<tr><td colspan="4" class="text-center">No hay datos de rúbrica para mostrar o el formato es incorrecto.</td></tr>');
                    return;
                }
                console.log("FUNC construirTablaRubricaVisualizacion: Datos de rúbrica válidos. Número de criterios:", rubricaData.criterios.length);

                let $headerRow = $('<tr>');
                $headerRow.append('<th class="text-start">Criterio</th>');
                $headerRow.append('<th class="text-start">Detalle</th>');
                $headerRow.append('<th class="text-center">Puntaje Obtenido (LLM)</th>');
                $headerRow.append('<th class="text-center">Puntaje Máx.</th>');
                $tabla.find('thead').append($headerRow);
                console.log("FUNC construirTablaRubricaVisualizacion: Fila de cabecera añadida.");

                const $tbody = $tabla.find('tbody');

                rubricaData.criterios.forEach((criterio, index) => {
                    console.log(`FUNC construirTablaRubricaVisualizacion: Procesando criterio ${index + 1}:`, criterio.nombre);
                    
                    const resultadoLLMCriterio = obtenerResultadoLLMParaCriterio(criterio.nombre, resultadosLLM);
                    // console.log(`FUNC construirTablaRubricaVisualizacion: Resultado LLM para '${criterio.nombre}':`, resultadoLLMCriterio);

                    let puntajeObtenidoEsteCriterio = 0;
                    if (resultadoLLMCriterio && typeof resultadoLLMCriterio.puntaje_obtenido_llm !== 'undefined' && resultadoLLMCriterio.puntaje_obtenido_llm !== null) {
                        puntajeObtenidoEsteCriterio = parseFloat(resultadoLLMCriterio.puntaje_obtenido_llm);
                        if (isNaN(puntajeObtenidoEsteCriterio)) {
                            console.warn(`FUNC construirTablaRubricaVisualizacion: puntaje_obtenido_llm para '${criterio.nombre}' no es un número válido:`, resultadoLLMCriterio.puntaje_obtenido_llm);
                            puntajeObtenidoEsteCriterio = 0;
                        }
                    } else {
                        console.warn(`FUNC construirTablaRubricaVisualizacion: No se encontró resultado LLM o puntaje_obtenido_llm es undefined/null para el criterio: '${criterio.nombre}'`);
                    }
                    
                    let maxPuntajeCriterio = 0;
                    if (typeof criterio.max_puntaje_criterio !== 'undefined' && criterio.max_puntaje_criterio !== null) {
                        maxPuntajeCriterio = parseFloat(criterio.max_puntaje_criterio);
                        if (isNaN(maxPuntajeCriterio)) {
                             console.warn(`FUNC construirTablaRubricaVisualizacion: max_puntaje_criterio para '${criterio.nombre}' no es un número válido:`, criterio.max_puntaje_criterio);
                            maxPuntajeCriterio = 0;
                        }
                    } else {
                        console.warn(`FUNC construirTablaRubricaVisualizacion: max_puntaje_criterio no definido o es null para '${criterio.nombre}'`);
                    }

                    let $filaCriterio = $('<tr>');
                    $filaCriterio.append($('<td>').text(criterio.nombre || 'N/A'));
                    $filaCriterio.append($('<td>').text(criterio.descripcion_general || 'N/A'));
                    $filaCriterio.append($('<td>').addClass('text-center').text(puntajeObtenidoEsteCriterio.toFixed(1)));
                    $filaCriterio.append($('<td>').addClass('text-center').text(maxPuntajeCriterio.toFixed(1)));
                    $tbody.append($filaCriterio);
                    // console.log(`FUNC construirTablaRubricaVisualizacion: Fila añadida para criterio '${criterio.nombre}' con puntaje ${puntajeObtenidoEsteCriterio.toFixed(1)}/${maxPuntajeCriterio.toFixed(1)}`);

                    if (resultadoLLMCriterio && resultadoLLMCriterio.feedback_criterio_llm) {
                        // console.log(`FUNC construirTablaRubricaVisualizacion: Añadiendo feedback para '${criterio.nombre}':`, resultadoLLMCriterio.feedback_criterio_llm);
                        let $feedbackRow = $('<tr class="table-light">');
                        let $feedbackCell = $('<td colspan="4" class="small fst-italic ps-4"></td>');
                        
                        $feedbackCell.append($('<i class="fas fa-comment-dots me-1"></i>'));
                        $feedbackCell.append($('<strong>').text('Feedback LLM: '));
                        $feedbackCell.append(document.createTextNode(resultadoLLMCriterio.feedback_criterio_llm));
                        
                        $feedbackRow.append($feedbackCell);
                        $tbody.append($feedbackRow);
                    }
                });
                console.log("FUNC construirTablaRubricaVisualizacion: Finalizado el bucle de criterios.");
            }

            // La llamada a la función
            const tablaIdFinal = 'tabla-rubrica-evaluacion-' + evaluacionId;
            console.log("SCRIPT: Llamando a construirTablaRubricaVisualizacion con tablaId:", tablaIdFinal);
            construirTablaRubricaVisualizacion(tablaIdFinal, rubricaEstructuraGlobal, resultadosLLMGlobal);
            console.log("SCRIPT: Llamada a construirTablaRubricaVisualizacion completada.");

        });
    </script>
{% endblock %}